\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager}{}\section{D\+M\+A\textbackslash{}Friends\textbackslash{}Classes\textbackslash{}Notifications\textbackslash{}Channel\+Manager Class Reference}
\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager}\index{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager@{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager}}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_aed4117d8bf3a210bf862a955d0b491e7}{register\+Input\+Validators} (array \$validators)
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a72c7ef4114ad52079a64cab5d1de87d7}{register\+Channels} (array \$channels)
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a2b416276f3d9dc6f8473df1938d1b1ef}{get\+Register\+Channels} (\$only\+Listenable=false)
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a7915392fc4aac067965d1009d7787e61}{get\+Channel\+Instance} (\$channel\+Key)
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_afb18d01faef45899f5a28544e5c9a6f6}{get\+Channel\+Setting\+Fields} ()
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a0d972a45e6595f13a52d2737755fed81}{send} (\$notification\+Name, \$callback, array \$sent\+By=\mbox{[}$\,$\mbox{]})
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_af48abc9be542bf1670f967b7cc3fd29f}{read\+Channels} ()
\item 
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a650da092e3c31849201e701e36eb12a5}{}{\bfseries listen} (\$arguments, Closure \$callback)\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a650da092e3c31849201e701e36eb12a5}

\end{DoxyCompactItemize}
\subsection*{Protected Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a3c76a0e6b0be8af57f08616c80efac7f}{call\+Notification\+Builder} (\$callback, \$notification)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
\hyperlink{namespaceDMA}{D\+M\+A} notification manager system \begin{DoxyAuthor}{Author}
Carlos Arroyo 
\end{DoxyAuthor}


\subsection{Member Function Documentation}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a3c76a0e6b0be8af57f08616c80efac7f}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!call\+Notification\+Builder@{call\+Notification\+Builder}}
\index{call\+Notification\+Builder@{call\+Notification\+Builder}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{call\+Notification\+Builder}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::call\+Notification\+Builder (
\begin{DoxyParamCaption}
\item[{}]{\$callback, }
\item[{}]{\$notification}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [protected]}}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a3c76a0e6b0be8af57f08616c80efac7f}
Pass a notification message to the Clouser before send through each channel 
\begin{DoxyParams}[1]{Parameters}
Closure & {\em \$callback} & \\
\hline
\textbackslash{}\+D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Notification\+Message & {\em \$notification} & \\
\hline
\end{DoxyParams}

\begin{DoxyExceptions}{Exceptions}
{\em } & \\
\hline
\end{DoxyExceptions}

\begin{DoxyCode}
120     \{
121         \textcolor{keywordflow}{if}($callback instanceof \hyperlink{namespaceClosure}{Closure})\{
122             \textcolor{keywordflow}{return} call\_user\_func($callback, $notification);
123         \}
124 
125         \textcolor{keywordflow}{throw} new \(\backslash\)InvalidArgumentException(\textcolor{stringliteral}{'Callback must be a Closure'});
126     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a7915392fc4aac067965d1009d7787e61}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!get\+Channel\+Instance@{get\+Channel\+Instance}}
\index{get\+Channel\+Instance@{get\+Channel\+Instance}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{get\+Channel\+Instance}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::get\+Channel\+Instance (
\begin{DoxyParamCaption}
\item[{}]{\$channel\+Key}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a7915392fc4aac067965d1009d7787e61}
Return an instance of the given key channel 
\begin{DoxyParams}[1]{Parameters}
string & {\em \$channel\+Key} & \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
\hyperlink{namespaceDMA}{D\+M\+A}\+: 
\end{DoxyReturn}

\begin{DoxyCode}
87                                                    \{
88         \textcolor{keywordflow}{return} $this->channels[$channelKey];
89     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_afb18d01faef45899f5a28544e5c9a6f6}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!get\+Channel\+Setting\+Fields@{get\+Channel\+Setting\+Fields}}
\index{get\+Channel\+Setting\+Fields@{get\+Channel\+Setting\+Fields}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{get\+Channel\+Setting\+Fields}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::get\+Channel\+Setting\+Fields (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_afb18d01faef45899f5a28544e5c9a6f6}
Return settings fields that should be add to Friends settings. \begin{DoxyReturn}{Returns}
array 
\end{DoxyReturn}

\begin{DoxyCode}
96                                              \{
97         $extra = [];
98         \textcolor{keywordflow}{foreach}($this->\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a2b416276f3d9dc6f8473df1938d1b1ef}{getRegisterChannels}() as $ch)\{
99             $fields = $ch->settingFields();
100             \textcolor{keywordflow}{if}(is\_array($fields))\{
101                 \textcolor{keywordflow}{foreach}($fields as $key => $opts)\{
102                     $info = $ch->getDetails();
103                     $tab = $info[\textcolor{stringliteral}{'name'}] . \textcolor{stringliteral}{' settings'};
104                     $opts[\textcolor{stringliteral}{'tab'}] = $tab;
105                     $extra[$key] = $opts;
106                 \}
107             \}
108         \}
109         \textcolor{keywordflow}{return} $extra;
110     \}    
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a2b416276f3d9dc6f8473df1938d1b1ef}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!get\+Register\+Channels@{get\+Register\+Channels}}
\index{get\+Register\+Channels@{get\+Register\+Channels}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{get\+Register\+Channels}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::get\+Register\+Channels (
\begin{DoxyParamCaption}
\item[{}]{\$only\+Listenable = {\ttfamily false}}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a2b416276f3d9dc6f8473df1938d1b1ef}
Return an array of all register notification channels 
\begin{DoxyParams}{Parameters}
{\em \$only\+Listenable} & Return only channels that implement read method \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
array 
\end{DoxyReturn}

\begin{DoxyCode}
68     \{
69         \textcolor{keywordflow}{if}(!$onlyListenable)\{
70             \textcolor{keywordflow}{return} $this->channels;
71         \}\textcolor{keywordflow}{else}\{
72             $channels = [];
73             \textcolor{keywordflow}{foreach} ($this->channels as $key => $ch)\{
74                 \textcolor{keywordflow}{if} ($ch instanceof Listenable)\{
75                     $channels[$key] = $this->channels[$key];
76                 \}
77             \}
78             \textcolor{keywordflow}{return} $channels;
79         \}
80     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_af48abc9be542bf1670f967b7cc3fd29f}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!read\+Channels@{read\+Channels}}
\index{read\+Channels@{read\+Channels}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{read\+Channels}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::read\+Channels (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_af48abc9be542bf1670f967b7cc3fd29f}
Implements internal polling for channels that are listenable 
\begin{DoxyCode}
194                                   \{
195 
196         $activeChannels = Settings::get(\textcolor{stringliteral}{'active\_listenable\_channels'}, []);
197         $channels = $this->channels;
198         \textcolor{comment}{// Filter out channels that are not enable in the settings}
199         $channels = array\_filter($channels, \textcolor{keyword}{function}($ch) use($activeChannels)\{
200             \textcolor{keywordflow}{if}(in\_array($ch->getKey(), $activeChannels))\{
201                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};
202             \}
203             \textcolor{keywordflow}{return} \textcolor{keyword}{false};
204         \});
205 
206         \textcolor{keywordflow}{foreach}($channels as $ch)\{
207 
208             \textcolor{keywordflow}{try}\{
209                 \textcolor{keywordflow}{if}($ch instanceof Listenable)\{
210                     \textcolor{comment}{// tell channel to check for new incoming data}
211                     $data = $ch->read();
212                     \textcolor{keywordflow}{if} (count($data) > 0)\{
213                         $channelCode = $ch->getKey();
214                         $event = \textcolor{stringliteral}{"dma.channel.$channelCode.incoming.data"};
215                         \(\backslash\)Event::fire($event, [$data]);
216                     \}
217                 \}
218 
219             \}\textcolor{keywordflow}{catch}(\(\backslash\)\hyperlink{namespaceException}{Exception} $e)\{
220                 \(\backslash\)Log::error($e);
221             \}
222         \}
223     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a72c7ef4114ad52079a64cab5d1de87d7}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!register\+Channels@{register\+Channels}}
\index{register\+Channels@{register\+Channels}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{register\+Channels}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::register\+Channels (
\begin{DoxyParamCaption}
\item[{array}]{\$channels}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a72c7ef4114ad52079a64cab5d1de87d7}
Register channels 
\begin{DoxyParams}[1]{Parameters}
array & {\em \$channels} & classnames of channels to be register \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
47     \{
48        \textcolor{keywordflow}{foreach}($channels as $class)\{
49 
50            $ch = \(\backslash\)App::make($class);
51 
52            \textcolor{comment}{// Run channel configurations}
53            $ch->configChannel();
54            $this->channels[$ch->getKey()] = $ch;
55        \}
56        
57        
58 
59     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_aed4117d8bf3a210bf862a955d0b491e7}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!register\+Input\+Validators@{register\+Input\+Validators}}
\index{register\+Input\+Validators@{register\+Input\+Validators}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{register\+Input\+Validators}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::register\+Input\+Validators (
\begin{DoxyParamCaption}
\item[{array}]{\$validators}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_aed4117d8bf3a210bf862a955d0b491e7}
Register inputs 
\begin{DoxyParams}[1]{Parameters}
array & {\em \$inputs} & classnames of input validators to be register \\
\hline
\end{DoxyParams}

\begin{DoxyCode}
35     \{
36         \textcolor{keywordflow}{foreach}($validators as $class)\{
37             $this->inputValidators[$class::getCode()] = $class;
38         \}
39     \}
\end{DoxyCode}
\hypertarget{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a0d972a45e6595f13a52d2737755fed81}{}\index{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}!send@{send}}
\index{send@{send}!D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager@{D\+M\+A\+::\+Friends\+::\+Classes\+::\+Notifications\+::\+Channel\+Manager}}
\subsubsection[{send}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Classes\textbackslash{}\+Notifications\textbackslash{}\+Channel\+Manager\+::send (
\begin{DoxyParamCaption}
\item[{}]{\$notification\+Name, }
\item[{}]{\$callback, }
\item[{array}]{\$sent\+By = {\ttfamily \mbox{[}\mbox{]}}}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a0d972a45e6595f13a52d2737755fed81}
Send a notification using all register channels if \$send\+By is not given. 
\begin{DoxyParams}[1]{Parameters}
string & {\em \$notification\+Name} & \\
\hline
Clouser & {\em \$callback} & \\
\hline
array & {\em \$data} & \\
\hline
array & {\em \$sent\+By} & \\
\hline
\end{DoxyParams}

\begin{DoxyExceptions}{Exceptions}
{\em } & \\
\hline
\end{DoxyExceptions}

\begin{DoxyCode}
138     \{
139 
140         $notification = \textcolor{keyword}{new} NotificationMessage;
141 
142         \textcolor{comment}{// Call callback to allow configure notification}
143         $this->\hyperlink{classDMA_1_1Friends_1_1Classes_1_1Notifications_1_1ChannelManager_a3c76a0e6b0be8af57f08616c80efac7f}{callNotificationBuilder}($callback, $notification);
144 
145         \textcolor{comment}{// Channels}
146         \textcolor{comment}{// Send notification to register channel}
147         $channels = [];
148         \textcolor{keywordflow}{if} (count($sentBy) > 0)\{
149             \textcolor{keywordflow}{foreach}($sentBy as $key)\{
150                 \textcolor{keywordflow}{if}($ch = @$this->channels[$key])\{
151                     $channels[$key] =$ch;
152                 \}\textcolor{keywordflow}{else}\{
153                     \textcolor{keywordflow}{throw} new \(\backslash\)Exception(\textcolor{stringliteral}{'Invalid channel '} . $key);
154                 \}
155             \}
156         \}\textcolor{keywordflow}{else}\{
157             $channels = $this->channels;
158         \}
159 
160         $activeChannels = Settings::get(\textcolor{stringliteral}{'active\_notification\_channels'}, []);
161 
162         \textcolor{keywordflow}{if} (!empty($activeChannels))\{
163             \textcolor{comment}{// Filter out channels that are not enable in the settings}
164             $channels = array\_filter($channels, \textcolor{keyword}{function}($ch) use($activeChannels)\{
165                 \textcolor{keywordflow}{if}(in\_array($ch->getKey(), $activeChannels))\{
166                     \textcolor{keywordflow}{return} \textcolor{keyword}{true};
167                 \}
168                 \textcolor{keywordflow}{return} \textcolor{keyword}{false};
169             \});
170         \}\textcolor{keywordflow}{else}\{
171             $channels = [];
172         \}
173 
174         \textcolor{keywordflow}{foreach}($channels as $channel)\{
175             \textcolor{keywordflow}{try}\{
176                 \textcolor{comment}{// Update view template for each channel}
177                 $view = sprintf(\textcolor{stringliteral}{'dma.friends::%s.%s'}, strtolower($channel->getKey()), $notificationName);
178                 $notification->setView($view);
179 
180                 \textcolor{comment}{// Send notification}
181                 $channel->send($notification);
182             \}\textcolor{keywordflow}{catch}(\(\backslash\)\hyperlink{namespaceException}{Exception} $e)\{
183                 \(\backslash\)Log::error($e);
184                 \textcolor{comment}{//throw $e;}
185             \}
186         \}
187 
188         \textcolor{keywordflow}{return} $notification;
189     \}
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
classes/notifications/Channel\+Manager.\+php\end{DoxyCompactItemize}

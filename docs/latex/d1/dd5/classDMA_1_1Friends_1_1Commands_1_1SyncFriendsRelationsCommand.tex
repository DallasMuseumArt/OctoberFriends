\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}{}\section{D\+M\+A\textbackslash{}Friends\textbackslash{}Commands\textbackslash{}Sync\+Friends\+Relations\+Command Class Reference}
\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}\index{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command@{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command}}
Inheritance diagram for D\+M\+A\textbackslash{}Friends\textbackslash{}Commands\textbackslash{}Sync\+Friends\+Relations\+Command\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=2.000000cm]{d1/dd5/classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}{\+\_\+\+\_\+construct} ()
\item 
\hyperlink{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}{fire} ()
\end{DoxyCompactItemize}
\subsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f2f9249d994c50002e593c9250d8940}{}{\bfseries \$name} = \textquotesingle{}friends\+:sync-\/relations\textquotesingle{}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f2f9249d994c50002e593c9250d8940}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_aa15d7cb86809962d2c857c75d803114a}{}{\bfseries \$description} = \textquotesingle{}Syncronize wordpress data relations\textquotesingle{}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_aa15d7cb86809962d2c857c75d803114a}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f80681225760f8800c68595db90e238}{}{\bfseries \$db} = null\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f80681225760f8800c68595db90e238}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_afede3d36037ec94d313e2382b9103896}{}{\bfseries \$user\+Step\+Table} = \textquotesingle{}dma\+\_\+friends\+\_\+step\+\_\+user\textquotesingle{}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_afede3d36037ec94d313e2382b9103896}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a4cabd040654272373d0d6828d4967529}{}{\bfseries \$user\+Badge\+Table} = \textquotesingle{}dma\+\_\+friends\+\_\+badge\+\_\+user\textquotesingle{}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a4cabd040654272373d0d6828d4967529}

\end{DoxyCompactItemize}


\subsection{Constructor \& Destructor Documentation}
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}{}\index{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}!\+\_\+\+\_\+construct@{\+\_\+\+\_\+construct}}
\index{\+\_\+\+\_\+construct@{\+\_\+\+\_\+construct}!D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}}
\subsubsection[{\+\_\+\+\_\+construct}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command\+::\+\_\+\+\_\+construct (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}
Create a new command instance. \begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}

\begin{DoxyCode}
58     \{   
59         \textcolor{keywordflow}{try} \{
60             $this->db = DB::connection(\textcolor{stringliteral}{'friends\_wordpress'});
61         \} \textcolor{keywordflow}{catch} (\(\backslash\)\hyperlink{namespaceInvalidArgumentException}{InvalidArgumentException} $e) \{
62             Log::info(\textcolor{stringliteral}{'Missing configuration for wordpress migration'});
63         \}
64 
65         parent::\_\_construct();
66     \}   
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}{}\index{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}!fire@{fire}}
\index{fire@{fire}!D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}}
\subsubsection[{fire}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command\+::fire (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}
Execute the console command. \begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}

\begin{DoxyCode}
73     \{  
74 
75         \textcolor{comment}{// Taxonomy terms}
76         $termRelations = $this->db->table(\textcolor{stringliteral}{'wp\_term\_relationships'})->get();
77 
78         \textcolor{keywordflow}{foreach}($termRelations as $relation) \{
79             $activity = Activity::findWordpress($relation->object\_id)->first();
80             
81             \textcolor{keywordflow}{if} ($activity) \{
82                 \textcolor{keywordflow}{if} (!$activity->categories->contains($relation->term\_taxonomy\_id)) \{
83                     $category = Category::find($relation->term\_taxonomy\_id);
84                     \textcolor{keywordflow}{if} ($category) \{
85                         $activity->categories()->save($category);
86                     \}
87                 \}
88             \}
89         \}
90 
91         \textcolor{comment}{// p2p connections}
92         $p2ps = $this->db->table(\textcolor{stringliteral}{'wp\_p2p'})
93             ->get();
94 
95         \textcolor{keywordflow}{foreach}($p2ps as $p2p) \{
96             list($from, $t, $to) = explode(\textcolor{charliteral}{'-'}, $p2p->p2p\_type);
97 
98             \textcolor{keywordflow}{switch}($from) \{
99                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'activity'}:
100                     $from = Activity::findWordpress($p2p->p2p\_from)->first();
101                     $from\_table = \textcolor{stringliteral}{'activity'};
102                     \textcolor{keywordflow}{break};
103                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'badge'}:
104                     $from = Badge::findWordpress($p2p->p2p\_from)->first();
105                     $from\_table = \textcolor{stringliteral}{'badge'};
106                     \textcolor{keywordflow}{break};
107                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma-location'}:
108                     $from = Location::findWordpress($p2p->p2p\_from)->first();
109                     $from\_table = \textcolor{stringliteral}{'location'};
110                     \textcolor{keywordflow}{break};
111                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'step'}:
112                     $from = Step::findWordpress($p2p->p2p\_from)->first();
113                     $from\_table = \textcolor{stringliteral}{'step'};
114                     \textcolor{keywordflow}{break};
115                 \textcolor{keywordflow}{default}:
116                     $from = \textcolor{keyword}{false};
117             \}
118 
119             \textcolor{keywordflow}{switch}($to) \{
120                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'activity'}:
121                     $to = Activity::findWordpress($p2p->p2p\_to)->first();
122                     $to\_table = \textcolor{stringliteral}{'activity'};
123                     \textcolor{keywordflow}{break};
124                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'badge'}:
125                     $to = Badge::findWordpress($p2p->p2p\_to)->first();
126                     $to\_table = \textcolor{stringliteral}{'badge'};
127                     \textcolor{keywordflow}{break};
128                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma-location'}:
129                     $to = Location::findWordpress($p2p->p2p\_to)->first();
130                     $to\_table = \textcolor{stringliteral}{'location'};
131                     \textcolor{keywordflow}{break};
132                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'step'}:
133                     $to = Step::findWordpress($p2p->p2p\_to)->first();
134                     $to\_table = \textcolor{stringliteral}{'step'}; 
135                     \textcolor{keywordflow}{break};
136                 \textcolor{keywordflow}{default}:
137                     $to = \textcolor{keyword}{false};
138             \}
139 
140             \textcolor{keywordflow}{if} ($from && $to) \{
141                 $table = \textcolor{stringliteral}{'dma\_friends\_'} . $from\_table . \textcolor{charliteral}{'\_'} . $to\_table;
142 
143                 \textcolor{keywordflow}{switch}($table) \{
144                     \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma\_friends\_activity\_step'}:
145                         $from->steps()->save($to);
146                         $this->info(\textcolor{stringliteral}{'activity: '} . $from->title . \textcolor{stringliteral}{' --> step: '} . $to->title);
147                         \textcolor{keywordflow}{break};
148                     \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma\_friends\_step\_badge'}:
149                         $to->steps()->save($from);
150                         $this->info(\textcolor{stringliteral}{'step: '} . $from->title . \textcolor{stringliteral}{' --> badge: '} . $to->title);
151                         \textcolor{keywordflow}{break};
152                     \textcolor{keywordflow}{default}:
153 
154                         $values = [
155                             $from\_table . \textcolor{stringliteral}{'\_id'}   => $from->id,
156                             $to\_table . \textcolor{stringliteral}{'\_id'}     => $to->id
157                         ];
158 
159                         \textcolor{keywordflow}{if} (Schema::hasTable($table)) \{
160                             DB::table($table)->insert($values);
161                             $this->info(\textcolor{stringliteral}{'from: '} . $from->title . \textcolor{stringliteral}{' ----- '} . $to->title);
162                         \} \textcolor{keywordflow}{else} \{
163                             $this->error(\textcolor{stringliteral}{'table doesnt exist: '} . $table);
164                         \} 
165 
166                 \}
167             \}
168         \}
169 
170         \textcolor{comment}{// User achievements}
171         $achievements = $this->db->table(\textcolor{stringliteral}{'wp\_usermeta'})
172             ->where(\textcolor{stringliteral}{'meta\_key'}, \textcolor{stringliteral}{'\_badgeos\_achievements'})
173             ->get();
174 
175         $post = \textcolor{keyword}{new} Post;
176 
177         $this->info(\textcolor{stringliteral}{'Sync Achievements'});        
178 
179         \textcolor{keywordflow}{foreach} ($achievements as $achievement) \{
180             $user = User::find($achievement->user\_id);
181 
182             \textcolor{keywordflow}{if} (empty($user)) \textcolor{keywordflow}{continue};
183 
184             \textcolor{comment}{// Flush existing records}
185             DB::table($this->userStepTable)
186                 ->where(\textcolor{stringliteral}{'user\_id'}, $user->id)
187                 ->delete();
188 
189             DB::table($this->userBadgeTable)
190                 ->where(\textcolor{stringliteral}{'user\_id'}, $user->id)
191                 ->delete();
192 
193             $data = unserialize($achievement->meta\_value);
194 
195             \textcolor{comment}{// wtf we don't need arrays in our arrays if we want to array}
196             $data = array\_pop($data);
197 
198             \textcolor{keywordflow}{foreach}($data as $d) \{
199 
200                 $link = [
201                     \textcolor{stringliteral}{'user\_id'}       => $user->id,
202                     \textcolor{stringliteral}{'created\_at'}    => $post->epochToTimestamp($d->date\_earned),
203                 ];
204 
205                 \textcolor{comment}{// About half way thru the data for the location key changes.}
206                 \textcolor{comment}{// so lets deal with that}
207                 \textcolor{keywordflow}{if} (isset($d->location)) \{
208                     $location\_id = $d->location;
209                 \} elseif (isset($d->location\_earned)) \{
210                     $location\_id = $d->location\_earned;
211                 \} \textcolor{keywordflow}{else} \{
212                     $location\_id = null;
213                 \}
214 
215                 $location = Location::findWordpress($location\_id)->first();
216                 \textcolor{keywordflow}{if} (isset($location->id)) \{
217                     $link[\textcolor{stringliteral}{'location\_id'}] = $location->id;
218                 \}
219 
220                 \textcolor{keywordflow}{if} ($d->post\_type == \textcolor{stringliteral}{'step'}) \{
221 
222                     $step = Step::findWordpress($d->ID)->first();
223                     \textcolor{keywordflow}{if} ($step) \{
224                         $link[\textcolor{stringliteral}{'step\_id'}] = $step->id;
225                         DB::table($this->userStepTable)->insert($link);
226                     \}
227 
228                 \} elseif ($d->post\_type == \textcolor{stringliteral}{'badge'}) \{
229 
230                     $badge = Badge::findWordpress($d->ID)->first();
231 
232                     \textcolor{keywordflow}{if} ($badge) \{
233                         $link[\textcolor{stringliteral}{'badge\_id'}] = $badge->id;
234                         DB::table($this->userBadgeTable)->insert($link);
235                     \}
236                 \}
237 
238             \}
239         \}
240 
241         \textcolor{comment}{// Syncronize activities and users}
242 
243         $this->info(\textcolor{stringliteral}{'Importing Activity/User relations'});
244         
245         $table = \textcolor{stringliteral}{'dma\_friends\_activity\_user'};
246 
247         DB::table($table)->delete();
248 
249         ActivityLog::where(\textcolor{stringliteral}{'action'}, \textcolor{charliteral}{'='}, \textcolor{stringliteral}{'activity'})->chunk(100, \textcolor{keyword}{function}($activityLogs) use ($table) \{
250             \textcolor{keywordflow}{foreach} ($activityLogs as $activityLog) \{
251 
252                 \textcolor{keywordflow}{if} ($activityLog->object\_id) \{
253 
254                     echo \textcolor{stringliteral}{'.'};
255 
256                     $pivotTable = [
257                         \textcolor{stringliteral}{'user\_id'}       => $activityLog->user\_id,
258                         \textcolor{stringliteral}{'activity\_id'}   => $activityLog->object\_id,
259                         \textcolor{stringliteral}{'created\_at'}    => $activityLog->timestamp,
260                         \textcolor{stringliteral}{'updated\_at'}    => $activityLog->timestamp,
261                     ];
262 
263                     DB::table($table)->insert($pivotTable);
264                 \}
265             \}
266         \});
267 
268         $this->info(\textcolor{stringliteral}{'Sync complete'});
269 
270     \}
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
commands/Sync\+Friends\+Relations\+Command.\+php\end{DoxyCompactItemize}

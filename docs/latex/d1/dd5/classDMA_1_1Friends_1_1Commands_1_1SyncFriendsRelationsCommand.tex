\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}{\section{D\+M\+A\textbackslash{}Friends\textbackslash{}Commands\textbackslash{}Sync\+Friends\+Relations\+Command Class Reference}
\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}\index{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command@{D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command}}
}
Inheritance diagram for D\+M\+A\textbackslash{}Friends\textbackslash{}Commands\textbackslash{}Sync\+Friends\+Relations\+Command\+:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=2.000000cm]{d1/dd5/classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}{\+\_\+\+\_\+construct} ()
\item 
\hyperlink{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}{fire} ()
\end{DoxyCompactItemize}
\subsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f2f9249d994c50002e593c9250d8940}{{\bfseries \$name} = 'friends\+:sync-\/relations'}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f2f9249d994c50002e593c9250d8940}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_aa15d7cb86809962d2c857c75d803114a}{{\bfseries \$description} = 'Syncronize wordpress data relations'}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_aa15d7cb86809962d2c857c75d803114a}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f80681225760f8800c68595db90e238}{{\bfseries \$db} = null}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a0f80681225760f8800c68595db90e238}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_afede3d36037ec94d313e2382b9103896}{{\bfseries \$user\+Step\+Table} = 'dma\+\_\+friends\+\_\+step\+\_\+user'}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_afede3d36037ec94d313e2382b9103896}

\item 
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a4cabd040654272373d0d6828d4967529}{{\bfseries \$user\+Badge\+Table} = 'dma\+\_\+friends\+\_\+badge\+\_\+user'}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a4cabd040654272373d0d6828d4967529}

\end{DoxyCompactItemize}


\subsection{Constructor \& Destructor Documentation}
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}{\index{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}!\+\_\+\+\_\+construct@{\+\_\+\+\_\+construct}}
\index{\+\_\+\+\_\+construct@{\+\_\+\+\_\+construct}!D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}}
\subsubsection[{\+\_\+\+\_\+construct}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command\+::\+\_\+\+\_\+construct (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_a199c1e86fcdeb44b66c5b3150cb737ad}
Create a new command instance. \begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}

\begin{DoxyCode}
57     \{   
58         $this->db = DB::connection(\textcolor{stringliteral}{'friends\_wordpress'});
59 
60         parent::\_\_construct();
61     \}   
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}{\index{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}!fire@{fire}}
\index{fire@{fire}!D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command@{D\+M\+A\+::\+Friends\+::\+Commands\+::\+Sync\+Friends\+Relations\+Command}}
\subsubsection[{fire}]{\setlength{\rightskip}{0pt plus 5cm}D\+M\+A\textbackslash{}\+Friends\textbackslash{}\+Commands\textbackslash{}\+Sync\+Friends\+Relations\+Command\+::fire (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{classDMA_1_1Friends_1_1Commands_1_1SyncFriendsRelationsCommand_acfb07355576a2f8583242ce4e145d7be}
Execute the console command. \begin{DoxyReturn}{Returns}
void 
\end{DoxyReturn}

\begin{DoxyCode}
68     \{  
69 
70         \textcolor{comment}{// Taxonomy terms}
71         $termRelations = $this->db->table(\textcolor{stringliteral}{'wp\_term\_relationships'})->get();
72 
73         \textcolor{keywordflow}{foreach}($termRelations as $relation) \{
74             $activity = Activity::findWordpress($relation->object\_id)->first();
75             
76             \textcolor{keywordflow}{if} ($activity) \{
77                 \textcolor{keywordflow}{if} (!$activity->categories->contains($relation->term\_taxonomy\_id)) \{
78                     $category = Category::find($relation->term\_taxonomy\_id);
79                     \textcolor{keywordflow}{if} ($category) \{
80                         $activity->categories()->save($category);
81                     \}
82                 \}
83             \}
84         \}
85 
86         \textcolor{comment}{// p2p connections}
87         $p2ps = $this->db->table(\textcolor{stringliteral}{'wp\_p2p'})
88             ->get();
89 
90         \textcolor{keywordflow}{foreach}($p2ps as $p2p) \{
91             list($from, $t, $to) = explode(\textcolor{charliteral}{'-'}, $p2p->p2p\_type);
92 
93             \textcolor{keywordflow}{switch}($from) \{
94                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'activity'}:
95                     $from = Activity::findWordpress($p2p->p2p\_from)->first();
96                     $from\_table = \textcolor{stringliteral}{'activity'};
97                     \textcolor{keywordflow}{break};
98                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'badge'}:
99                     $from = Badge::findWordpress($p2p->p2p\_from)->first();
100                     $from\_table = \textcolor{stringliteral}{'badge'};
101                     \textcolor{keywordflow}{break};
102                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma-location'}:
103                     $from = Location::findWordpress($p2p->p2p\_from)->first();
104                     $from\_table = \textcolor{stringliteral}{'location'};
105                     \textcolor{keywordflow}{break};
106                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'step'}:
107                     $from = Step::findWordpress($p2p->p2p\_from)->first();
108                     $from\_table = \textcolor{stringliteral}{'step'};
109                     \textcolor{keywordflow}{break};
110                 \textcolor{keywordflow}{default}:
111                     $from = \textcolor{keyword}{false};
112             \}
113 
114             \textcolor{keywordflow}{switch}($to) \{
115                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'activity'}:
116                     $to = Activity::findWordpress($p2p->p2p\_to)->first();
117                     $to\_table = \textcolor{stringliteral}{'activity'};
118                     \textcolor{keywordflow}{break};
119                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'badge'}:
120                     $to = Badge::findWordpress($p2p->p2p\_to)->first();
121                     $to\_table = \textcolor{stringliteral}{'badge'};
122                     \textcolor{keywordflow}{break};
123                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma-location'}:
124                     $to = Location::findWordpress($p2p->p2p\_to)->first();
125                     $to\_table = \textcolor{stringliteral}{'location'};
126                     \textcolor{keywordflow}{break};
127                 \textcolor{keywordflow}{case} \textcolor{stringliteral}{'step'}:
128                     $to = Step::findWordpress($p2p->p2p\_to)->first();
129                     $to\_table = \textcolor{stringliteral}{'step'}; 
130                     \textcolor{keywordflow}{break};
131                 \textcolor{keywordflow}{default}:
132                     $to = \textcolor{keyword}{false};
133             \}
134 
135             \textcolor{keywordflow}{if} ($from && $to) \{
136                 $table = \textcolor{stringliteral}{'dma\_friends\_'} . $from\_table . \textcolor{charliteral}{'\_'} . $to\_table;
137 
138                 \textcolor{keywordflow}{switch}($table) \{
139                     \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma\_friends\_activity\_step'}:
140                         $from->steps()->save($to);
141                         $this->info(\textcolor{stringliteral}{'activity: '} . $from->title . \textcolor{stringliteral}{' --> step: '} . $to->title);
142                         \textcolor{keywordflow}{break};
143                     \textcolor{keywordflow}{case} \textcolor{stringliteral}{'dma\_friends\_step\_badge'}:
144                         $to->steps()->save($from);
145                         $this->info(\textcolor{stringliteral}{'step: '} . $from->title . \textcolor{stringliteral}{' --> badge: '} . $to->title);
146                         \textcolor{keywordflow}{break};
147                     \textcolor{keywordflow}{default}:
148 
149                         $values = [
150                             $from\_table . \textcolor{stringliteral}{'\_id'}   => $from->id,
151                             $to\_table . \textcolor{stringliteral}{'\_id'}     => $to->id
152                         ];
153 
154                         \textcolor{keywordflow}{if} (Schema::hasTable($table)) \{
155                             DB::table($table)->insert($values);
156                             $this->info(\textcolor{stringliteral}{'from: '} . $from->title . \textcolor{stringliteral}{' ----- '} . $to->title);
157                         \} \textcolor{keywordflow}{else} \{
158                             $this->error(\textcolor{stringliteral}{'table doesnt exist: '} . $table);
159                         \} 
160 
161                 \}
162             \}
163         \}
164 
165         \textcolor{comment}{// User achievements}
166         $achievements = $this->db->table(\textcolor{stringliteral}{'wp\_usermeta'})
167             ->where(\textcolor{stringliteral}{'meta\_key'}, \textcolor{stringliteral}{'\_badgeos\_achievements'})
168             ->get();
169 
170         $post = \textcolor{keyword}{new} Post;
171 
172         $this->info(\textcolor{stringliteral}{'Sync Achievements'});        
173 
174         \textcolor{keywordflow}{foreach} ($achievements as $achievement) \{
175             $user = User::find($achievement->user\_id);
176 
177             \textcolor{keywordflow}{if} (empty($user)) \textcolor{keywordflow}{continue};
178 
179             \textcolor{comment}{// Flush existing records}
180             DB::table($this->userStepTable)
181                 ->where(\textcolor{stringliteral}{'user\_id'}, $user->id)
182                 ->delete();
183 
184             DB::table($this->userBadgeTable)
185                 ->where(\textcolor{stringliteral}{'user\_id'}, $user->id)
186                 ->delete();
187 
188             $data = unserialize($achievement->meta\_value);
189 
190             \textcolor{comment}{// wtf we don't need arrays in our arrays if we want to array}
191             $data = array\_pop($data);
192 
193             \textcolor{keywordflow}{foreach}($data as $d) \{
194 
195                 $link = [
196                     \textcolor{stringliteral}{'user\_id'}       => $user->id,
197                     \textcolor{stringliteral}{'created\_at'}    => $post->epochToTimestamp($d->date\_earned),
198                 ];
199 
200                 \textcolor{comment}{// About half way thru the data for the location key changes.}
201                 \textcolor{comment}{// so lets deal with that}
202                 \textcolor{keywordflow}{if} (isset($d->location)) \{
203                     $location\_id = $d->location;
204                 \} elseif (isset($d->location\_earned)) \{
205                     $location\_id = $d->location\_earned;
206                 \} \textcolor{keywordflow}{else} \{
207                     $location\_id = null;
208                 \}
209 
210                 $location = Location::findWordpress($location\_id)->first();
211                 \textcolor{keywordflow}{if} (isset($location->id)) \{
212                     $link[\textcolor{stringliteral}{'location\_id'}] = $location->id;
213                 \}
214 
215                 \textcolor{keywordflow}{if} ($d->post\_type == \textcolor{stringliteral}{'step'}) \{
216 
217                     $step = Step::findWordpress($d->ID)->first();
218                     \textcolor{keywordflow}{if} ($step) \{
219                         $link[\textcolor{stringliteral}{'step\_id'}] = $step->id;
220                         DB::table($this->userStepTable)->insert($link);
221                     \}
222 
223                 \} elseif ($d->post\_type == \textcolor{stringliteral}{'badge'}) \{
224 
225                     $badge = Badge::findWordpress($d->ID)->first();
226 
227                     \textcolor{keywordflow}{if} ($badge) \{
228                         $link[\textcolor{stringliteral}{'badge\_id'}] = $badge->id;
229                         DB::table($this->userBadgeTable)->insert($link);
230                     \}
231                 \}
232 
233             \}
234         \}
235 
236         \textcolor{comment}{// Syncronize activities and users}
237 
238         $this->info(\textcolor{stringliteral}{'Importing Activity/User relations'});
239         
240         $table = \textcolor{stringliteral}{'dma\_friends\_activity\_user'};
241 
242         DB::table($table)->delete();
243 
244         ActivityLog::where(\textcolor{stringliteral}{'action'}, \textcolor{charliteral}{'='}, \textcolor{stringliteral}{'activity'})->chunk(100, \textcolor{keyword}{function}($activityLogs) use ($table) \{
245             \textcolor{keywordflow}{foreach} ($activityLogs as $activityLog) \{
246 
247                 \textcolor{keywordflow}{if} ($activityLog->object\_id) \{
248 
249                     echo \textcolor{stringliteral}{'.'};
250 
251                     $pivotTable = [
252                         \textcolor{stringliteral}{'user\_id'}       => $activityLog->user\_id,
253                         \textcolor{stringliteral}{'activity\_id'}   => $activityLog->object\_id,
254                         \textcolor{stringliteral}{'created\_at'}    => $activityLog->timestamp,
255                         \textcolor{stringliteral}{'updated\_at'}    => $activityLog->timestamp,
256                     ];
257 
258                     DB::table($table)->insert($pivotTable);
259                 \}
260             \}
261         \});
262 
263         $this->info(\textcolor{stringliteral}{'Sync complete'});
264 
265     \}
\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
commands/Sync\+Friends\+Relations\+Command.\+php\end{DoxyCompactItemize}
